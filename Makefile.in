#+##############################################################################
#                                                                              #
# File: Makefile.in                                                            #
#                                                                              #
# Description: skeleton toplevel Makefile                                      #
#                                                                              #
#-##############################################################################

# Author: Lionel Cons (http://cern.ch/lionel.cons)
# Copyright (C) CERN 2012-2017

VERSION=@VERSION@
PKGTAG=v$(VERSION)
PKGDIR=libdirq-$(VERSION)
TARBALL=$(PKGDIR).tar.gz
PKGFILES=CHANGES DESIGN LICENSE README.md VERSION \
 Makefile.in Makefile configure doc src libdirq.spec

.PHONY: all test install sources tag clean distclean

all test install:
	make -C doc $@
	make -C src $@

sources: $(TARBALL)

$(TARBALL):
	@tempdir=`mktemp -d -t c-dirq-XXXXX`; \
	mkdir $$tempdir/$(PKGDIR); \
	cp -a $(PKGFILES) $$tempdir/$(PKGDIR); \
	( cd $$tempdir/$(PKGDIR); make distclean); \
	( cd $$tempdir; tar cvfz $(TARBALL) $(PKGDIR) ); \
	mv -f $$tempdir/$(TARBALL) $(TARBALL); \
	rm -fr $$tempdir

tag:
	@seen=`git tag -l | grep -Fx $(PKGTAG)`; \
	if [ "x$$seen" = "x" ]; then \
	    set -x; \
	    git tag $(PKGTAG); \
	    git push --tags; \
	else \
	    echo "already tagged with $(PKGTAG)"; \
	fi

clean:
	@make -C doc clean
	@make -C src clean
	rm -f $(TARBALL) *~

distclean: clean
	rm -f Makefile doc/Makefile src/Makefile src/libdirq.pc
